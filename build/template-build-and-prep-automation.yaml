parameters:
  MSAL_DESKTOP_ONLY_DEV: ''
  PUBLISH_OUTPUT: true

steps:
# Bootstrap the build
- template: template-bootstrap-build.yaml

# Unit tests require .NET 3.x
- task: UseDotNet@2
  displayName: 'Use .Net Core SDK 3.x'
  inputs:
    version: 3.x
    
# Use the latest .NET SDK
- task: UseDotNet@2
  displayName: 'Use .Net Core sdk 6.x'
  inputs:
    version: 6.x

# Nuget Restore and Build 
- template: template-restore-build-libsandsamples.yaml
  parameters:
    BuildPlatform: '$(BuildPlatform)'
    BuildConfiguration: '$(BuildConfiguration)'
    MsalClientSemVer: $(MsalClientSemVer)
    MSAL_DESKTOP_ONLY_DEV: ${{ parameters.MSAL_DESKTOP_ONLY_DEV }}
    Solution: 'LibsAndSamples.sln'

- task: CopyFiles@2
  displayName: 'Stage MSAL src'
  condition: eq(parameters.PUBLISH_OUTPUT, true)
  inputs:
    SourceFolder: src\client
    Contents: '**\**.cs'
    TargetFolder: '$(build.artifactstagingdirectory)/msalSrc'

- task: CopyFiles@2
  displayName: 'Stage MSAL src bin'
  condition: eq(parameters.PUBLISH_OUTPUT, true)
  inputs:
    SourceFolder: src\client
    Contents: '**\bin\**\*'
    TargetFolder: '$(build.artifactstagingdirectory)/msalSrc'

- task: CopyFiles@2
  displayName: 'Stage MSAL tests'
  condition: eq(parameters.PUBLISH_OUTPUT, true)
  inputs:
    SourceFolder: tests
    Contents: |
      Microsoft.Identity**\bin\**\**
      !Microsoft.Identity*Common\**\*
      !Microsoft.Identity*LabInfrastructure\**\*
      !Microsoft.Identity*Performance\**\*
    TargetFolder: '$(build.artifactstagingdirectory)/msalTests'

- task: CopyFiles@2
  displayName: 'Stage Device Authentication Tests'
  condition: eq(parameters.PUBLISH_OUTPUT, true)
  inputs:
    SourceFolder: tests/Microsoft.Identity.Test.Integration.Win8
    Contents: '**/bin/**/*'
    TargetFolder: '$(build.artifactstagingdirectory)/DeviceAuth'

- task: PublishPipelineArtifact@1
  displayName: 'Publish Artifact: drop'
  condition: eq(parameters.PUBLISH_OUTPUT, true)
  inputs:
    targetPath: $(Build.artifactstagingdirectory)
    artifactName: drop
