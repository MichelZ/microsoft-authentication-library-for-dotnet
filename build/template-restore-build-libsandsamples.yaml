# template-restore-build-libsandsamples.yaml
# Performs Nuget Restore and Build of LibsAndSamples.sln based on BuildPlatform and BuildConfiguration

parameters:
  BuildPlatform: 'any cpu'
  BuildConfiguration: 'debug'
  MsalClientSemVer: '4.0.0-devopsbuild'

steps:
- task: CmdLine@2
  displayName: 'Clear local NuGet cache'
  inputs:
    script: 'nuget locals all -clear'

- task: Cache@2
  displayName: Cache
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/packages.lock.json,!**/bin/**,!**/obj/**'
    path: '$(Pipeline.Workspace)/.nuget/packages'
    cacheHitVar: 'CACHE_RESTORED'

#Restore workload with the .NET Core CLI task
- task: DotNetCoreCLI@2
  displayName: 'dotnet workload restore for Desktop project'
  inputs:
    command: 'custom'
    custom: 'workload'
    arguments: 'restore .\src\client\Microsoft.Identity.Client.Desktop\Microsoft.Identity.Client.Desktop.csproj'

- task: DotNetCoreCLI@2
  displayName: 'dotnet workload restore'
  inputs:
    command: 'custom'
    custom: 'workload'
    arguments: 'restore .\src\client\Microsoft.Identity.Client\Microsoft.Identity.Client.csproj'

- task: NuGetCommand@2
  displayName: 'NuGet restore (nuget.exe) ${{ parameters.Solution }}'
  enabled: true
  inputs:
    command: 'restore'
    restoreSolution: ${{ parameters.Solution }}

- task: VSBuild@1
  displayName: 'NuGet restore ${{ parameters.Solution }}'
  inputs:
    solution: ${{ parameters.Solution }}
    msbuildArgs: '/t:restore /p:RestoreUseStaticGraphEvaluation=true'
    platform: ${{ parameters.BuildPlatform }}
    configuration: ${{ parameters.BuildConfiguration }}
    maximumCpuCount: true

- task: VSBuild@1
  displayName: 'Build solution ${{ parameters.Solution }}'
  inputs:
    solution: ${{ parameters.Solution }}
    msbuildArgs: '/p:RunCodeAnalysis=false /p:MsalClientSemVer=${{ parameters.MsalClientSemVer }} /p:SourceLinkCreate=true /p:ContinousIntegrationBuild=true /p:RestoreUseStaticGraphEvaluation=true'
    platform: ${{ parameters.BuildPlatform }}
    configuration: ${{ parameters.BuildConfiguration }}
    maximumCpuCount: true
